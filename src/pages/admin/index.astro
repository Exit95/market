---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { requireAdmin, isAuthContext } from "../../lib/auth-middleware";

const auth = await requireAdmin(Astro.request, Astro.cookies);
if (!isAuthContext(auth)) return Astro.redirect("/anmelden");

const [queueRes, auditRes] = await Promise.all([
    fetch(`${Astro.url.origin}/api/admin/review-queue`, {
        headers: Astro.request.headers,
    }),
    fetch(`${Astro.url.origin}/api/admin/audit-log`, {
        headers: Astro.request.headers,
    }),
]);

const queue: any[] = queueRes.ok ? await queueRes.json() : [];
const recent: any[] = auditRes.ok ? await auditRes.json() : [];

const critCount = queue.filter((e) =>
    e.signals.some((s: any) => s.severity === "CRITICAL"),
).length;
const highCount = queue.filter((e) =>
    e.signals.some((s: any) => s.severity === "HIGH"),
).length;
const totalSignals = queue.reduce(
    (n: number, e: any) => n + e.signals.length,
    0,
);

const SEV_COLOR: Record<string, string> = {
    CRITICAL: "#ef4444",
    HIGH: "#f97316",
    MEDIUM: "#eab308",
    LOW: "#64748b",
};
---

<BaseLayout title="Admin Panel â€“ Novamarkt">
    <Header />
    <main class="container adm-wrap">
        <div class="adm-header">
            <h1>âš™ Admin Panel</h1>
            <span class="badge badge-primary">Admin: {auth.user.email}</span>
        </div>

        <!-- Stats row -->
        <div class="stat-row">
            <div class="stat-card critical">
                <div class="stat-val">{critCount}</div><div class="stat-label">
                    CRITICAL
                </div>
            </div>
            <div class="stat-card high">
                <div class="stat-val">{highCount}</div>
                <div class="stat-label">HIGH</div>
            </div>
            <div class="stat-card neutral">
                <div class="stat-val">{totalSignals}</div><div
                    class="stat-label"
                >
                    Alle Signale
                </div>
            </div>
        </div>

        <!-- Review Queue -->
        <section class="adm-section">
            <h2>ðŸš¨ Review Queue</h2>
            {queue.length === 0 && <p class="empty">Keine offenen Signale.</p>}
            {
                queue.map((entry: any) => (
                    <div class="user-card" data-uid={entry.user.id}>
                        <div class="uc-header">
                            <span class="uc-name">
                                {entry.user.firstName ?? "?"}{" "}
                                {entry.user.lastName?.[0] ?? ""}. â€”{" "}
                                <code>{entry.user.email}</code>
                            </span>
                            <div class="uc-badges">
                                {entry.user.bannedAt && (
                                    <span class="badge badge-danger">
                                        GESPERRT
                                    </span>
                                )}
                                {entry.user.shadowBanned && (
                                    <span class="badge badge-warning">
                                        SHADOW
                                    </span>
                                )}
                                {entry.user.trustScore && (
                                    <span class="badge">
                                        {entry.user.trustScore.level}{" "}
                                        {entry.user.trustScore.score}pt
                                    </span>
                                )}
                            </div>
                        </div>

                        <div class="signals-list">
                            {entry.signals.map((sig: any) => (
                                <div
                                    class="signal-row"
                                    style={`border-left: 3px solid ${SEV_COLOR[sig.severity] ?? "#999"}`}
                                >
                                    <span class="sig-type">{sig.type}</span>
                                    <span
                                        class="sig-sev"
                                        style={`color:${SEV_COLOR[sig.severity]}`}
                                    >
                                        {sig.severity}
                                    </span>
                                    <code class="sig-meta">
                                        {JSON.stringify(sig.metaJson)}
                                    </code>
                                    <button
                                        class="btn btn-ghost btn-xs"
                                        data-resolve={sig.id}
                                    >
                                        âœ“ Resolve
                                    </button>
                                </div>
                            ))}
                        </div>

                        <div class="uc-actions">
                            {!entry.user.bannedAt ? (
                                <button
                                    class="btn btn-danger btn-xs"
                                    data-action="ban"
                                    data-uid={entry.user.id}
                                >
                                    Sperren
                                </button>
                            ) : (
                                <button
                                    class="btn btn-secondary btn-xs"
                                    data-action="unban"
                                    data-uid={entry.user.id}
                                >
                                    Entsperren
                                </button>
                            )}
                            {!entry.user.shadowBanned ? (
                                <button
                                    class="btn btn-warning btn-xs"
                                    data-action="shadowban"
                                    data-uid={entry.user.id}
                                >
                                    Shadowban
                                </button>
                            ) : (
                                <button
                                    class="btn btn-ghost btn-xs"
                                    data-action="unshadowban"
                                    data-uid={entry.user.id}
                                >
                                    Unshadowban
                                </button>
                            )}
                            {!entry.user.idVerified ? (
                                <button
                                    class="btn btn-primary btn-xs"
                                    data-action="verifyId"
                                    data-uid={entry.user.id}
                                >
                                    ID Verify
                                </button>
                            ) : (
                                <button
                                    class="btn btn-ghost btn-xs"
                                    data-action="removeVerifyId"
                                    data-uid={entry.user.id}
                                >
                                    ID Entziehen
                                </button>
                            )}
                        </div>
                    </div>
                ))
            }
        </section>

        <!-- Recent Audit Log -->
        <section class="adm-section">
            <h2>ðŸ“‹ Letzte Admin-Aktionen</h2>
            {recent.length === 0 && <p class="empty">Keine EintrÃ¤ge.</p>}
            <table class="adm-table">
                {
                    recent.map((a: any) => (
                        <tr>
                            <td class="at-time">
                                {new Date(a.createdAt).toLocaleString("de-DE")}
                            </td>
                            <td>
                                <code>{a.action}</code>
                            </td>
                            <td class="at-meta">
                                {JSON.stringify(a.metaJson ?? {})}
                            </td>
                        </tr>
                    ))
                }
            </table>
        </section>
    </main>
    <Footer />
</BaseLayout>

<style>
    .adm-wrap {
        padding: 2rem 0 4rem;
    }
    .adm-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .adm-header h1 {
        font-size: var(--text-2xl);
        font-weight: 800;
    }
    .stat-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .stat-card {
        padding: 1.25rem;
        border-radius: var(--radius-lg);
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        text-align: center;
    }
    .stat-card.critical {
        border-color: #ef4444;
    }
    .stat-card.high {
        border-color: #f97316;
    }
    .stat-val {
        font-size: 2rem;
        font-weight: 900;
    }
    .stat-label {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        font-weight: 600;
        text-transform: uppercase;
    }
    .adm-section {
        margin-bottom: 2.5rem;
    }
    .adm-section h2 {
        font-size: var(--text-lg);
        font-weight: 700;
        margin-bottom: 1rem;
    }
    .empty {
        color: var(--color-text-muted);
        padding: 1rem;
    }
    .user-card {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: 1rem 1.25rem;
        margin-bottom: 0.75rem;
    }
    .uc-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }
    .uc-name {
        font-weight: 600;
        font-size: var(--text-sm);
    }
    .uc-badges {
        display: flex;
        gap: 0.4rem;
    }
    .signals-list {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        margin-bottom: 0.75rem;
    }
    .signal-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.4rem 0.75rem;
        background: var(--color-surface-2);
        border-radius: var(--radius);
        flex-wrap: wrap;
    }
    .sig-type {
        font-weight: 700;
        font-size: var(--text-xs);
    }
    .sig-sev {
        font-size: var(--text-xs);
        font-weight: 700;
    }
    .sig-meta {
        font-size: 0.65rem;
        color: var(--color-text-muted);
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .uc-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    .btn-warning {
        background: rgba(234, 179, 8, 0.15);
        color: #eab308;
        border: 1px solid rgba(234, 179, 8, 0.3);
    }
    .btn-warning:hover {
        background: #eab308;
        color: #000;
    }
    .btn-xs {
        padding: 0.25rem 0.6rem;
        font-size: 0.75rem;
    }
    .adm-table {
        width: 100%;
        border-collapse: collapse;
        font-size: var(--text-xs);
    }
    .adm-table tr {
        border-bottom: 1px solid var(--color-border);
    }
    .adm-table td {
        padding: 0.5rem 0.75rem;
    }
    .at-time {
        color: var(--color-text-muted);
        white-space: nowrap;
    }
    .at-meta {
        color: var(--color-text-muted);
        max-width: 400px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>

<script>
    // Admin action buttons
    document.querySelectorAll("[data-action]").forEach((btn) => {
        (btn as HTMLElement).addEventListener("click", async () => {
            const uid = (btn as HTMLElement).dataset.uid!;
            const action = (btn as HTMLElement).dataset.action!;
            const reason = action === "ban" ? prompt("Sperrgrund:") : undefined;
            if (action === "ban" && !reason) return;

            const res = await fetch(`/api/admin/users/${uid}/action`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action, ...(reason && { reason }) }),
            });
            if (res.ok) location.reload();
            else alert("Fehler: " + (await res.json()).error);
        });
    });

    // Resolve signal buttons
    document.querySelectorAll("[data-resolve]").forEach((btn) => {
        (btn as HTMLElement).addEventListener("click", async () => {
            const sigId = (btn as HTMLElement).dataset.resolve!;
            // Find parent user card for uid
            const card = (btn as HTMLElement).closest(
                "[data-uid]",
            ) as HTMLElement;
            const uid = card?.dataset.uid!;
            const res = await fetch(`/api/admin/users/${uid}/action`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    action: "resolveSignal",
                    signalId: sigId,
                }),
            });
            if (res.ok) location.reload();
        });
    });
</script>
