---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { requireAuth, isAuthContext } from "../../lib/auth-middleware";

const auth = await requireAuth(Astro.request, Astro.cookies);
if (!isAuthContext(auth)) return Astro.redirect("/anmelden");

const cId = Astro.params.id!;

// Fetch conversation and messages
const [convRes, msgRes] = await Promise.all([
    fetch(`${Astro.url.origin}/api/conversations`, {
        headers: Astro.request.headers,
    }),
    fetch(`${Astro.url.origin}/api/conversations/${cId}/messages`, {
        headers: Astro.request.headers,
    }),
]);

const convs: any[] = convRes.ok ? await convRes.json() : [];
const conv = convs.find((c: any) => c.id === cId);
const initialMsgs: any[] = msgRes.ok ? await msgRes.json() : [];

if (!conv) return Astro.redirect("/messages");
const myId = auth.userId;
const other = conv.buyerId === myId ? conv.seller : conv.buyer;
---

<BaseLayout title={`Chat mit ${other.firstName} – Novamarkt`}>
    <Header />
    <main class="chat-layout">
        <!-- Sidebar -->
        <aside class="conv-sidebar">
            <div class="sidebar-header">Nachrichten</div>
            {
                convs.map((c: any) => {
                    const o = c.buyerId === myId ? c.seller : c.buyer;
                    return (
                        <a
                            href={`/messages/${c.id}`}
                            class={`sidebar-conv ${c.id === cId ? "active" : ""}`}
                        >
                            <div class="sa">{o.firstName?.[0] ?? "?"}</div>
                            <div class="si">
                                <div class="sn">
                                    {o.firstName} {o.lastName?.[0]}.
                                </div>
                                <div class="sl">{c.listing.title}</div>
                            </div>
                        </a>
                    );
                })
            }
        </aside>

        <!-- Chat area -->
        <section class="chat-main">
            <header class="chat-header">
                <div class="ch-avatar">{other.firstName?.[0] ?? "?"}</div>
                <div>
                    <div class="ch-name">
                        {other.firstName}
                        {other.lastName?.[0]}.
                    </div>
                    <a href={`/listing/${conv.listing.id}`} class="ch-listing"
                        >{conv.listing.title}</a
                    >
                </div>
            </header>

            <div class="messages-area" id="messagesArea">
                {
                    initialMsgs.map((m: any) => (
                        <div
                            class={`msg-bubble ${m.senderId === myId ? "mine" : "theirs"}`}
                            data-id={m.id}
                        >
                            <div class="msg-body">{m.body}</div>
                            <div class="msg-time">
                                {new Date(m.createdAt).toLocaleTimeString(
                                    "de-DE",
                                    { hour: "2-digit", minute: "2-digit" },
                                )}
                            </div>
                        </div>
                    ))
                }
            </div>

            <form class="chat-input-row" id="msgForm">
                <input
                    id="msgInput"
                    type="text"
                    placeholder="Nachricht schreiben…"
                    class="input chat-input"
                    maxlength="2000"
                    autocomplete="off"
                />
                <button type="submit" class="btn btn-primary">Senden</button>
            </form>
            <div id="filterError" class="filter-error" hidden></div>
        </section>
    </main>
    <Footer />
</BaseLayout>

<style>
    .chat-layout {
        display: grid;
        grid-template-columns: 280px 1fr;
        height: calc(100vh - 64px);
        overflow: hidden;
    }
    @media (max-width: 768px) {
        .chat-layout {
            grid-template-columns: 1fr;
        }
        .conv-sidebar {
            display: none;
        }
    }

    /* Sidebar */
    .conv-sidebar {
        border-right: 1px solid var(--color-border);
        overflow-y: auto;
        background: var(--color-surface);
    }
    .sidebar-header {
        padding: 1rem 1.25rem;
        font-weight: 700;
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        border-bottom: 1px solid var(--color-border);
    }
    .sidebar-conv {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        text-decoration: none;
        color: inherit;
        border-bottom: 1px solid var(--color-border);
        transition: background 0.1s;
    }
    .sidebar-conv:hover,
    .sidebar-conv.active {
        background: var(--color-surface-2);
    }
    .sa {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--color-primary-glow);
        color: var(--color-primary);
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    .sn {
        font-size: var(--text-sm);
        font-weight: 600;
    }
    .sl {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 180px;
    }

    /* Chat */
    .chat-main {
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .chat-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--color-border);
        background: var(--color-surface);
    }
    .ch-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--color-primary-glow);
        color: var(--color-primary);
        font-weight: 800;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    .ch-name {
        font-weight: 700;
    }
    .ch-listing {
        font-size: var(--text-xs);
        color: var(--color-primary);
        text-decoration: none;
    }
    .ch-listing:hover {
        text-decoration: underline;
    }
    .messages-area {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    .msg-bubble {
        max-width: 72%;
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }
    .msg-bubble.mine {
        align-self: flex-end;
        align-items: flex-end;
    }
    .msg-bubble.theirs {
        align-self: flex-start;
        align-items: flex-start;
    }
    .msg-body {
        padding: 0.6rem 1rem;
        border-radius: 1.2rem;
        font-size: var(--text-sm);
        line-height: 1.5;
        word-break: break-word;
    }
    .mine .msg-body {
        background: var(--color-primary);
        color: #fff;
        border-bottom-right-radius: 0.3rem;
    }
    .theirs .msg-body {
        background: var(--color-surface-2);
        border: 1px solid var(--color-border);
        border-bottom-left-radius: 0.3rem;
    }
    .msg-time {
        font-size: 0.65rem;
        color: var(--color-text-muted);
    }
    .chat-input-row {
        display: flex;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border-top: 1px solid var(--color-border);
        background: var(--color-surface);
    }
    .chat-input {
        flex: 1;
    }
    .filter-error {
        color: #ef4444;
        font-size: var(--text-xs);
        padding: 0.25rem 1rem 0.5rem;
    }
</style>

<script define:vars={{ cId, myId }}>
    const area = document.getElementById("messagesArea");
    const form = document.getElementById("msgForm");
    const input = document.getElementById("msgInput");
    const filterEl = document.getElementById("filterError");

    // Scroll to bottom
    area.scrollTop = area.scrollHeight;

    function appendMsg(m) {
        const div = document.createElement("div");
        div.className = `msg-bubble ${m.sender?.id === myId || m.senderId === myId ? "mine" : "theirs"}`;
        div.dataset.id = m.id;
        const time = new Date(m.createdAt).toLocaleTimeString("de-DE", {
            hour: "2-digit",
            minute: "2-digit",
        });
        div.innerHTML = `<div class="msg-body">${m.body.replace(/</g, "&lt;")}</div><div class="msg-time">${time}</div>`;
        area.appendChild(div);
        area.scrollTop = area.scrollHeight;
    }

    // Send message
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const body = input.value.trim();
        if (!body) return;
        filterEl.hidden = true;
        input.disabled = true;

        const res = await fetch(`/api/conversations/${cId}/messages`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ body }),
        });
        input.disabled = false;

        if (!res.ok) {
            const { error } = await res.json();
            filterEl.textContent = "⚠ " + error;
            filterEl.hidden = false;
            return;
        }
        input.value = "";
        // Message will arrive via Ably; no need to manually append (dedup by id)
    });

    // Ably Realtime subscription
    async function startAbly() {
        const tokenRes = await fetch(`/api/conversations/${cId}/ably-token`);
        if (!tokenRes.ok) return;
        const tokenRequest = await tokenRes.json();

        const { Realtime } =
            await import("https://cdn.ably.com/lib/ably.min-2.js");
        const ably = new Realtime({
            authCallback: (_params, cb) => cb(null, tokenRequest),
        });
        const channel = ably.channels.get(`conversation:${cId}`);

        const seen = new Set(
            [...area.querySelectorAll("[data-id]")].map((el) => el.dataset.id),
        );
        channel.subscribe("message", (msg) => {
            if (seen.has(msg.data.id)) return;
            seen.add(msg.data.id);
            appendMsg(msg.data);
        });
    }

    startAbly().catch(console.error);
</script>
