---
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
---

<BaseLayout title="Nachrichten ‚Äì Novamarkt">
    <Header />
    <main class="messages-main">
        <div class="messages-layout">
            <!-- Sidebar: Conversations -->
            <aside class="conversations-sidebar">
                <div class="sidebar-header">
                    <h2 class="sidebar-title">Meine Chats</h2>
                    <span class="badge badge-primary">3 neu</span>
                </div>
                <div class="search-wrap" style="margin-bottom:var(--space-4);">
                    <svg
                        class="search-icon"
                        width="14"
                        height="14"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        ><circle cx="11" cy="11" r="8"></circle><path
                            d="m21 21-4.35-4.35"></path></svg
                    >
                    <input
                        type="text"
                        placeholder="Chats durchsuchen..."
                        class="search-input"
                        style="font-size:var(--text-sm);"
                    />
                </div>
                <div class="conversation-list">
                    <div class="conversation-item active" data-chat="1">
                        <div class="conv-avatar">K</div>
                        <div class="conv-info">
                            <div class="conv-name-row">
                                <span class="conv-name">Klaus M.</span>
                                <span class="conv-time">Jetzt</span>
                            </div>
                            <div class="conv-preview">
                                Hallo, ist das iPhone noch verf√ºgbar?
                            </div>
                            <div class="conv-listing">iPhone 15 Pro Max</div>
                        </div>
                        <div class="conv-badge">2</div>
                    </div>
                    <div class="conversation-item" data-chat="2">
                        <div class="conv-avatar verified">A</div>
                        <div class="conv-info">
                            <div class="conv-name-row">
                                <span class="conv-name">Anna S.</span>
                                <span class="conv-time">14:23</span>
                            </div>
                            <div class="conv-preview">
                                Ich biete 65‚Ç¨ f√ºr das Regal
                            </div>
                            <div class="conv-listing">IKEA KALLAX Regal</div>
                        </div>
                        <div class="conv-badge">1</div>
                    </div>
                    <div class="conversation-item" data-chat="3">
                        <div class="conv-avatar">T</div>
                        <div class="conv-info">
                            <div class="conv-name-row">
                                <span class="conv-name">Thomas B.</span>
                                <span class="conv-time">Gestern</span>
                            </div>
                            <div class="conv-preview">
                                Super, dann bis Samstag!
                            </div>
                            <div class="conv-listing">Mountainbike Trek</div>
                        </div>
                    </div>
                    <div class="conversation-item" data-chat="4">
                        <div class="conv-avatar">J</div>
                        <div class="conv-info">
                            <div class="conv-name-row">
                                <span class="conv-name">J√∂rg L.</span>
                                <span class="conv-time">Mo</span>
                            </div>
                            <div class="conv-preview">
                                Danke f√ºr die Bewertung!
                            </div>
                            <div class="conv-listing">Sony Kopfh√∂rer</div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Chat Area -->
            <div class="chat-area">
                <div class="chat-header">
                    <div class="chat-user-info">
                        <div class="chat-avatar">K</div>
                        <div>
                            <div class="chat-user-name">
                                Klaus M.
                                <span
                                    class="trust-badge trust-kyc"
                                    style="font-size:0.6rem; padding:2px 7px;"
                                    >KYC</span
                                >
                                <span
                                    class="trust-badge trust-verified"
                                    style="font-size:0.6rem; padding:2px 7px;"
                                    >‚úì</span
                                >
                            </div>
                            <div class="chat-status">
                                <span class="online-dot"></span>
                                Online ¬∑ Antwortet normalerweise sofort
                            </div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <div class="listing-ref">
                            <img
                                src="https://images.unsplash.com/photo-1695048133142-1a20484429be?w=60&h=45&fit=crop"
                                alt="iPhone"
                                class="ref-img"
                            />
                            <div>
                                <div class="ref-title">iPhone 15 Pro Max</div>
                                <div class="ref-price">949 ‚Ç¨</div>
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-sm"
                            >Anzeige anzeigen</button
                        >
                    </div>
                </div>

                <!-- Fraud Warning Banner -->
                <div class="fraud-warning-banner" id="fraudBanner">
                    <button class="fraud-close" id="closeFraud">‚úï</button>
                    <svg
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        ><path
                            d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
                        ></path><line x1="12" y1="9" x2="12" y2="13"
                        ></line><line x1="12" y1="17" x2="12.01" y2="17"
                        ></line></svg
                    >
                    <div>
                        <strong>Sicherheitshinweis:</strong> Achte darauf, dass du
                        nur √ºber unser Treuhandkonto zahlst. Zahle <strong
                            >niemals</strong
                        > per "PayPal Freunde & Familie" oder Vorkasse auf private
                        Konten.
                    </div>
                </div>

                <!-- Messages -->
                <div class="messages-scroll" id="messagesArea">
                    <div class="date-separator"><span>Heute</span></div>

                    <div class="message incoming">
                        <div class="msg-avatar">K</div>
                        <div class="msg-bubble">
                            <p>
                                Hallo! Ich habe dein Inserat gesehen. Ist das
                                iPhone noch verf√ºgbar?
                            </p>
                            <span class="msg-time">10:15</span>
                        </div>
                    </div>

                    <div class="message outgoing">
                        <div class="msg-bubble">
                            <p>
                                Ja, das iPhone ist noch verf√ºgbar! Es ist in
                                einem sehr guten Zustand, keine Kratzer.
                            </p>
                            <span class="msg-time">10:18</span>
                        </div>
                    </div>

                    <div class="message incoming">
                        <div class="msg-avatar">K</div>
                        <div class="msg-bubble">
                            <p>
                                Super! Ist ein Versand m√∂glich? Und w√§rst du
                                bereit auf 900‚Ç¨ runterzugehen?
                            </p>
                            <span class="msg-time">10:22</span>
                        </div>
                    </div>

                    <div class="message outgoing">
                        <div class="msg-bubble">
                            <p>
                                Versand ist kein Problem, am besten √ºber das
                                Treuhandkonto hier auf Novamarkt. Beim Preis
                                geht leider nichts mehr unter 930‚Ç¨.
                            </p>
                            <span class="msg-time">10:25</span>
                        </div>
                    </div>

                    <!-- Fraud detection alert message -->
                    <div class="fraud-alert-msg">
                        <svg
                            width="14"
                            height="14"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2.5"
                            ><path
                                d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"
                            ></path></svg
                        >
                        <div>
                            <strong>Sicherheitstipp erkannt:</strong> Der Verk√§ufer
                            schlug Treuhandkonto vor ‚Äì das ist der sichere Weg!
                        </div>
                    </div>

                    <div class="message incoming">
                        <div class="msg-avatar">K</div>
                        <div class="msg-bubble">
                            <p>
                                Okay, 930‚Ç¨ ist ein Deal! Wie funktioniert das
                                mit dem Treuhandkonto genau?
                            </p>
                            <span class="msg-time">10:28</span>
                        </div>
                    </div>

                    <div class="message outgoing">
                        <div class="msg-bubble">
                            <p>
                                Du zahlst √ºber Novamarkt ‚Äì dein Geld bleibt
                                erst auf dem Konto. Ich schicke das iPhone per
                                DHL. Wenn du es erhalten hast und alles passt,
                                gibst du die Zahlung frei. Sehr sicher f√ºr uns
                                beide!
                            </p>
                            <span class="msg-time">10:30</span>
                        </div>
                    </div>

                    <div class="message incoming">
                        <div class="msg-avatar">K</div>
                        <div class="msg-bubble">
                            <p>
                                Perfekt! Dann w√ºrde ich das gerne so machen. ü§ù
                            </p>
                            <span class="msg-time">10:32</span>
                        </div>
                    </div>
                </div>

                <!-- Treuhand CTA -->
                <div class="treuhand-cta">
                    <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2.5"
                        ><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"
                        ></path><polyline points="9 12 11 14 15 10"
                        ></polyline></svg
                    >
                    <span>Treuhand-Kauf starten (empfohlen)</span>
                    <button class="btn btn-primary btn-sm"
                        >Jetzt sicher bezahlen</button
                    >
                </div>

                <!-- Message Input -->
                <div class="message-input-area">
                    <div class="fraud-scanner">
                        <svg
                            width="12"
                            height="12"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            ><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"
                            ></polyline></svg
                        >
                        Betrugsscanner aktiv
                    </div>
                    <div class="input-row">
                        <button
                            class="btn btn-ghost btn-icon attach-btn"
                            title="Datei anh√§ngen"
                        >
                            <svg
                                width="18"
                                height="18"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                ><path
                                    d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"
                                ></path></svg
                            >
                        </button>
                        <textarea
                            class="msg-input input"
                            rows="1"
                            placeholder="Nachricht tippen... (Shift+Enter f√ºr Zeilenumbruch)"
                            id="msgInput"></textarea>
                        <button class="btn btn-primary send-btn" id="sendBtn">
                            <svg
                                width="18"
                                height="18"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                ><line x1="22" y1="2" x2="11" y2="13"
                                ></line><polygon
                                    points="22 2 15 22 11 13 2 9 22 2"
                                ></polygon></svg
                            >
                        </button>
                    </div>
                    <div class="input-warning" id="inputWarning"></div>
                </div>
            </div>
        </div>
    </main>
    <Footer />
</BaseLayout>

<style>
    .messages-main {
        height: calc(100vh - 70px);
        overflow: hidden;
    }
    .messages-layout {
        display: grid;
        grid-template-columns: 340px 1fr;
        height: 100%;
    }

    /* Sidebar */
    .conversations-sidebar {
        background: var(--color-surface);
        border-right: 1px solid var(--color-border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .sidebar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-5) var(--space-5) var(--space-3);
    }
    .sidebar-title {
        font-size: var(--text-base);
        font-weight: 700;
    }
    .search-wrap {
        margin: 0 var(--space-4) var(--space-3);
        border-radius: var(--radius);
    }
    .conversation-list {
        flex: 1;
        overflow-y: auto;
    }
    .conversation-item {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-4) var(--space-5);
        cursor: pointer;
        transition: background var(--transition);
        position: relative;
    }
    .conversation-item:hover {
        background: var(--color-surface-2);
    }
    .conversation-item.active {
        background: rgba(6, 182, 212, 0.06);
        border-right: 3px solid var(--color-primary);
    }
    .conv-avatar {
        width: 44px;
        height: 44px;
        background: linear-gradient(
            135deg,
            var(--color-primary),
            var(--color-accent)
        );
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #0b1120;
        flex-shrink: 0;
    }
    .conv-avatar.verified {
        background: linear-gradient(135deg, var(--color-success), #34d399);
    }
    .conv-info {
        flex: 1;
        min-width: 0;
    }
    .conv-name-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .conv-name {
        font-size: var(--text-sm);
        font-weight: 600;
    }
    .conv-time {
        font-size: var(--text-xs);
        color: var(--color-text-faint);
    }
    .conv-preview {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-top: 2px;
    }
    .conv-listing {
        font-size: 0.65rem;
        color: var(--color-primary);
        font-weight: 600;
        margin-top: 2px;
    }
    .conv-badge {
        width: 20px;
        height: 20px;
        background: var(--color-primary);
        color: #0b1120;
        border-radius: 50%;
        font-size: 0.65rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    /* Chat Area */
    .chat-area {
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .chat-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-4) var(--space-6);
        border-bottom: 1px solid var(--color-border);
        background: var(--color-surface);
        flex-wrap: wrap;
        gap: var(--space-3);
    }
    .chat-user-info {
        display: flex;
        align-items: center;
        gap: var(--space-3);
    }
    .chat-avatar {
        width: 44px;
        height: 44px;
        background: linear-gradient(
            135deg,
            var(--color-primary),
            var(--color-accent)
        );
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #0b1120;
        flex-shrink: 0;
    }
    .chat-user-name {
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: var(--space-1);
        flex-wrap: wrap;
    }
    .chat-status {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        display: flex;
        align-items: center;
        gap: var(--space-2);
        margin-top: 2px;
    }
    .online-dot {
        width: 8px;
        height: 8px;
        background: var(--color-success);
        border-radius: 50%;
    }
    .chat-actions {
        display: flex;
        align-items: center;
        gap: var(--space-3);
    }
    .listing-ref {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        background: var(--color-surface-2);
        border-radius: var(--radius);
        padding: var(--space-2) var(--space-3);
        border: 1px solid var(--color-border);
    }
    .ref-img {
        width: 40px;
        height: 30px;
        object-fit: cover;
        border-radius: var(--radius-sm);
    }
    .ref-title {
        font-size: var(--text-xs);
        font-weight: 600;
    }
    .ref-price {
        font-size: var(--text-xs);
        color: var(--color-primary);
        font-weight: 700;
    }

    /* Fraud Banner */
    .fraud-warning-banner {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        padding: var(--space-3) var(--space-6);
        background: rgba(245, 158, 11, 0.08);
        border-bottom: 1px solid rgba(245, 158, 11, 0.2);
        font-size: var(--text-xs);
        color: var(--color-warning);
        position: relative;
    }
    .fraud-warning-banner svg {
        flex-shrink: 0;
        margin-top: 2px;
    }
    .fraud-close {
        position: absolute;
        right: var(--space-4);
        top: var(--space-3);
        background: none;
        border: none;
        color: var(--color-text-faint);
        cursor: pointer;
        font-size: 0.8rem;
    }
    .fraud-close:hover {
        color: var(--color-warning);
    }

    /* Messages Area */
    .messages-scroll {
        flex: 1;
        overflow-y: auto;
        padding: var(--space-6);
        display: flex;
        flex-direction: column;
        gap: var(--space-4);
    }
    .date-separator {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        margin: var(--space-2) 0;
    }
    .date-separator::before,
    .date-separator::after {
        content: "";
        flex: 1;
        height: 1px;
        background: var(--color-border);
    }
    .date-separator span {
        font-size: var(--text-xs);
        color: var(--color-text-faint);
        font-weight: 500;
    }
    .message {
        display: flex;
        gap: var(--space-3);
        align-items: flex-end;
    }
    .message.outgoing {
        flex-direction: row-reverse;
    }
    .msg-avatar {
        width: 32px;
        height: 32px;
        background: linear-gradient(
            135deg,
            var(--color-primary),
            var(--color-accent)
        );
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-xs);
        font-weight: 700;
        color: #0b1120;
        flex-shrink: 0;
    }
    .msg-bubble {
        max-width: 65%;
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius-xl);
        position: relative;
    }
    .message.incoming .msg-bubble {
        background: var(--color-surface-2);
        border-bottom-left-radius: var(--radius-sm);
    }
    .message.outgoing .msg-bubble {
        background: rgba(6, 182, 212, 0.15);
        border-bottom-right-radius: var(--radius-sm);
        border: 1px solid rgba(6, 182, 212, 0.25);
    }
    .msg-bubble p {
        font-size: var(--text-sm);
        line-height: 1.6;
    }
    .msg-time {
        display: block;
        font-size: 0.65rem;
        color: var(--color-text-faint);
        margin-top: var(--space-1);
        text-align: right;
    }
    .fraud-alert-msg {
        display: flex;
        align-items: flex-start;
        gap: var(--space-2);
        background: rgba(16, 185, 129, 0.06);
        border: 1px solid rgba(16, 185, 129, 0.2);
        border-radius: var(--radius);
        padding: var(--space-3);
        font-size: var(--text-xs);
        color: var(--color-success);
        align-self: center;
        max-width: 80%;
        text-align: center;
    }

    /* Treuhand CTA */
    .treuhand-cta {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-3) var(--space-6);
        background: rgba(16, 185, 129, 0.06);
        border-top: 1px solid rgba(16, 185, 129, 0.2);
        border-bottom: 1px solid rgba(16, 185, 129, 0.2);
        font-size: var(--text-sm);
        color: var(--color-success);
        font-weight: 500;
    }
    .treuhand-cta span {
        flex: 1;
    }

    /* Message Input */
    .message-input-area {
        padding: var(--space-4) var(--space-6);
        border-top: 1px solid var(--color-border);
        background: var(--color-surface);
    }
    .fraud-scanner {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--text-xs);
        color: var(--color-success);
        margin-bottom: var(--space-2);
    }
    .input-row {
        display: flex;
        align-items: flex-end;
        gap: var(--space-3);
    }
    .msg-input {
        flex: 1;
        resize: none;
        border-radius: var(--radius-lg);
        max-height: 120px;
        overflow-y: auto;
        line-height: 1.5;
    }
    .send-btn {
        border-radius: var(--radius-lg) !important;
        width: 44px;
        height: 44px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    .attach-btn {
        color: var(--color-text-faint);
        flex-shrink: 0;
    }
    .input-warning {
        font-size: var(--text-xs);
        color: var(--color-warning);
        margin-top: var(--space-1);
        min-height: 16px;
    }

    @media (max-width: 768px) {
        .messages-layout {
            grid-template-columns: 1fr;
        }
        .conversations-sidebar {
            display: none;
        }
        .chat-header {
            flex-direction: column;
            align-items: flex-start;
        }
        .listing-ref {
            display: none;
        }
    }
</style>

<script>
    // Close fraud banner
    document.getElementById("closeFraud")?.addEventListener("click", () => {
        const banner = document.getElementById("fraudBanner");
        if (banner) banner.style.display = "none";
    });

    // Fraud word detection
    const fraudKeywords = [
        "paypal freunde",
        "family & friends",
        "vorkasse",
        "western union",
        "paysafecard",
        "bitcoin",
        "crypto",
    ];
    document.getElementById("msgInput")?.addEventListener("input", (e) => {
        const val = (e.target as HTMLTextAreaElement).value.toLowerCase();
        const warning = document.getElementById("inputWarning");
        if (!warning) return;
        if (fraudKeywords.some((kw) => val.includes(kw))) {
            warning.textContent =
                "‚ö†Ô∏è Achtung: Keine Zahlung au√üerhalb des Treuhandkontos! Dies ist ein typischer Betrugsversuch.";
        } else {
            warning.textContent = "";
        }
        // Auto-resize
        const el = e.target as HTMLTextAreaElement;
        el.style.height = "auto";
        el.style.height = Math.min(el.scrollHeight, 120) + "px";
    });

    // Send message
    document.getElementById("sendBtn")?.addEventListener("click", () => {
        const input = document.getElementById(
            "msgInput",
        ) as HTMLTextAreaElement;
        const text = input.value.trim();
        if (!text) return;

        const area = document.getElementById("messagesArea");
        if (!area) return;

        const msgEl = document.createElement("div");
        msgEl.className = "message outgoing animate-fade-up";
        const now = new Date();
        const time = `${now.getHours()}:${now.getMinutes().toString().padStart(2, "0")}`;
        msgEl.innerHTML = `<div class="msg-bubble"><p>${text}</p><span class="msg-time">${time}</span></div>`;
        area.appendChild(msgEl);
        input.value = "";
        input.style.height = "44px";
        area.scrollTop = area.scrollHeight;
    });

    // Conversation switching
    document.querySelectorAll(".conversation-item").forEach((item) => {
        item.addEventListener("click", () => {
            document
                .querySelectorAll(".conversation-item")
                .forEach((i) => i.classList.remove("active"));
            item.classList.add("active");
        });
    });
</script>
