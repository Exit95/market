---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { requireAuth, isAuthContext } from "../../lib/auth-middleware";

// Protect page – redirect to login if unauthenticated
const auth = await requireAuth(Astro.request, Astro.cookies);
if (!isAuthContext(auth)) return Astro.redirect("/anmelden");

const res = await fetch(
    `${Astro.url.origin}/api/listings?status=ACTIVE&pageSize=100`,
    { headers: Astro.request.headers },
);

// Fetch only this user's listings by filtering on client (no sellerId filter in API yet)
const allData = res.ok ? await res.json() : { listings: [] };
const myListings = (allData.listings ?? []).filter(
    (l: any) => l.seller?.id === auth.userId,
);

const STATUS_LABEL: Record<string, string> = {
    DRAFT: "Entwurf",
    ACTIVE: "Aktiv",
    RESERVED: "Reserviert",
    SOLD: "Verkauft",
    ARCHIVED: "Archiviert",
    REMOVED: "Gelöscht",
};
---

<BaseLayout title="Meine Anzeigen – Novamarkt">
    <Header />
    <main class="container dash-wrap">
        <div class="dash-header">
            <h1>Meine Anzeigen</h1>
            <a href="/inserat-erstellen" class="btn btn-primary"
                >+ Neue Anzeige</a
            >
        </div>

        {
            myListings.length === 0 && (
                <div class="empty-state">
                    <p>Du hast noch keine Anzeigen.</p>
                    <a
                        href="/inserat-erstellen"
                        class="btn btn-primary"
                        style="margin-top:1rem;"
                    >
                        Erste Anzeige erstellen
                    </a>
                </div>
            )
        }

        <div class="listing-table-wrap">
            {
                myListings.length > 0 && (
                    <table class="listing-table">
                        <thead>
                            <tr>
                                <th>Titel</th>
                                <th>Preis</th>
                                <th>Kategorie</th>
                                <th>Status</th>
                                <th>Aufrufe</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {myListings.map((l: any) => (
                                <tr>
                                    <td>
                                        <a href={`/listing/${l.id}`}>
                                            {l.title}
                                        </a>
                                    </td>
                                    <td>
                                        {(l.price / 100).toLocaleString(
                                            "de-DE",
                                            {
                                                style: "currency",
                                                currency: "EUR",
                                            },
                                        )}
                                    </td>
                                    <td>{l.category}</td>
                                    <td>
                                        <span
                                            class={`status-badge status-${l.status.toLowerCase()}`}
                                        >
                                            {STATUS_LABEL[l.status] ?? l.status}
                                        </span>
                                    </td>
                                    <td>{l.viewCount}</td>
                                    <td class="action-cell">
                                        <button
                                            class="btn btn-ghost btn-xs"
                                            data-action="archive"
                                            data-id={l.id}
                                        >
                                            Archivieren
                                        </button>
                                        <button
                                            class="btn btn-danger btn-xs"
                                            data-action="delete"
                                            data-id={l.id}
                                        >
                                            Löschen
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                )
            }
        </div>
    </main>
    <Footer />
</BaseLayout>

<style>
    .dash-wrap {
        padding-top: 2rem;
        padding-bottom: 4rem;
    }
    .dash-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }
    .dash-header h1 {
        font-size: var(--text-2xl);
        font-weight: 800;
    }
    .empty-state {
        text-align: center;
        padding: 4rem;
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border);
    }
    .listing-table-wrap {
        overflow-x: auto;
    }
    .listing-table {
        width: 100%;
        border-collapse: collapse;
    }
    .listing-table th,
    .listing-table td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid var(--color-border);
        font-size: var(--text-sm);
    }
    .listing-table th {
        font-weight: 600;
        color: var(--color-text-muted);
        background: var(--color-surface);
    }
    .listing-table tr:hover td {
        background: var(--color-surface-2);
    }
    .listing-table a {
        color: var(--color-primary);
        text-decoration: none;
        font-weight: 600;
    }
    .status-badge {
        padding: 0.2rem 0.65rem;
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
        font-weight: 600;
    }
    .status-active {
        background: rgba(16, 185, 129, 0.12);
        color: #10b981;
    }
    .status-draft {
        background: rgba(100, 116, 139, 0.12);
        color: #64748b;
    }
    .status-sold {
        background: rgba(6, 182, 212, 0.12);
        color: var(--color-primary);
    }
    .status-archived,
    .status-removed {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }
    .action-cell {
        display: flex;
        gap: 0.5rem;
    }
    .btn-xs {
        padding: 0.25rem 0.6rem;
        font-size: 0.75rem;
    }
    .btn-danger {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }
    .btn-danger:hover {
        background: #ef4444;
        color: white;
    }
</style>

<script>
    document.querySelectorAll("[data-action]").forEach((btn) => {
        btn.addEventListener("click", async () => {
            const id = (btn as HTMLElement).dataset.id!;
            const action = (btn as HTMLElement).dataset.action!;
            const body = action === "archive" ? { status: "ARCHIVED" } : null;

            if (
                !confirm(
                    action === "delete"
                        ? "Anzeige wirklich löschen?"
                        : "Anzeige archivieren?",
                )
            )
                return;

            const res = await fetch(`/api/listings/${id}`, {
                method: action === "delete" ? "DELETE" : "PATCH",
                headers: { "Content-Type": "application/json" },
                body: body ? JSON.stringify(body) : undefined,
            });

            if (res.ok) location.reload();
            else alert("Fehler: " + (await res.json()).error);
        });
    });
</script>
